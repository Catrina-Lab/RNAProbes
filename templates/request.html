{% extends 'base.html' %}

{% block content %}
<div id="form_container">
  {% include 'request-form.html' %}
</div>
<div id="response_container" class="container d-none">
  <div class="text-center mb-5">
    <h1 class="display-5">Processing Your Requests</h1>
    <p class="lead text-muted">You can monitor the progress of each tool below.</p>
  </div>
  <div class="row justify-content-center">
    <div class="col-lg-8">
      {% for program in programs %}
        <div id="{{program}}-container">
          {% include 'request-received.html' %}
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector("form");
    if (!form) return;

    const responseContainer = document.getElementById("response_container");
    const formContainer = document.getElementById("form_container");
    const programs = {{ programs | tojson }};
    const resultUrls = {};

    form.addEventListener("submit", e => {
      e.preventDefault();
      formContainer.classList.add("d-none");
      responseContainer.classList.remove("d-none");
      sendRequests();
    });

    document.addEventListener('click', e => {
      const downloadBtn = e.target.closest('[id$="-download-btn"]');
      if (downloadBtn) {
        const program = downloadBtn.id.split("-", 1)[0];
        downloadFile(program);
      }
    });

    function sendRequests() {
      programs.forEach(sendRequest);
    }

    async function sendRequest(program) {
      const data = new FormData(form);
      const response = await fetch(`/send-request?program=${program}`, {
        method: "POST",
        body: data,
      });
      const responseJson = await response.json();
      renderResponse(responseJson, program);
    }

    function renderResponse(response, program) {
      saveURL(response.zip, program);
      renderTemplate(response.html, program);
    }

    function saveURL(zip, program) {
      const zipFile = new Blob([base64ToUint8Array(zip)], { type: 'application/zip' });
      resultUrls[program] = URL.createObjectURL(zipFile);
    }

    function base64ToUint8Array(encoded) {
      const binary = atob(encoded);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < bytes.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes;
    }

    function renderTemplate(html, program) {
      document.getElementById(`${program}-container`).innerHTML = html;
    }

    function downloadFile(program) {
      const anchor = document.getElementById(`${program}-download-anchor`);
      if (anchor && resultUrls[program]) {
        anchor.href = resultUrls[program];
        anchor.click();
      }
    }
  });
</script>
{% endblock %}